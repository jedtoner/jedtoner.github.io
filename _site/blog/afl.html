<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jed Toner">
<meta name="dcterms.date" content="2025-09-30">

<title>AFL Prediction Model – Jed Toner - Personal Website</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-f59cc608e70ce16b384b3e6fc30ca698.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Jed Toner - Personal Website</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../CV.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jedtoner"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/jed-toner"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
        
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">AFL Prediction Model</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jed Toner </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 30, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>The following is a hierarchical bayesian model for AFL games, this model will be trained on the first 17 rounds of an AFL season, and tested on the final 6/7 rounds of the season</p>
<div id="cell-2" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Libraries used for model and analysis</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pymc <span class="im">as</span> pm</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> PCA</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytensor.tensor <span class="im">as</span> pt</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>WARNING (pytensor.tensor.blas): Using NumPy C-API based implementation for BLAS functions.</code></pre>
</div>
</div>
<p>Step 1: Obtaining the data</p>
<p>The data is obtained from Kaggle: https://www.kaggle.com/datasets/stoney71/aflstats/data?select=stats.csv</p>
<p>Some preprocessing will need to be done to ensure it will work with the pymc model</p>
<div id="cell-4" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>games <span class="op">=</span> pd.read_csv(<span class="st">'data/games.csv'</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>games.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">GameId</th>
<th data-quarto-table-cell-role="th">Year</th>
<th data-quarto-table-cell-role="th">Round</th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">MaxTemp</th>
<th data-quarto-table-cell-role="th">MinTemp</th>
<th data-quarto-table-cell-role="th">Rainfall</th>
<th data-quarto-table-cell-role="th">Venue</th>
<th data-quarto-table-cell-role="th">StartTime</th>
<th data-quarto-table-cell-role="th">Attendance</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">HomeTeamScoreHT</th>
<th data-quarto-table-cell-role="th">HomeTeamScore3QT</th>
<th data-quarto-table-cell-role="th">HomeTeamScoreFT</th>
<th data-quarto-table-cell-role="th">HomeTeamScore</th>
<th data-quarto-table-cell-role="th">AwayTeam</th>
<th data-quarto-table-cell-role="th">AwayTeamScoreQT</th>
<th data-quarto-table-cell-role="th">AwayTeamScoreHT</th>
<th data-quarto-table-cell-role="th">AwayTeamScore3QT</th>
<th data-quarto-table-cell-role="th">AwayTeamScoreFT</th>
<th data-quarto-table-cell-role="th">AwayTeamScore</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2012R0101</td>
<td>2012</td>
<td>R1</td>
<td>2012-03-24</td>
<td>24.0</td>
<td>12.2</td>
<td>0.0</td>
<td>Stadium Australia</td>
<td>7:20 PM</td>
<td>38,203</td>
<td>...</td>
<td>3.3</td>
<td>3.4</td>
<td>5.70</td>
<td>37</td>
<td>Sydney</td>
<td>4.1</td>
<td>8.4</td>
<td>13.80</td>
<td>14.16</td>
<td>100</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2012R0102</td>
<td>2012</td>
<td>R1</td>
<td>2012-03-29</td>
<td>25.7</td>
<td>9.7</td>
<td>0.0</td>
<td>M.C.G.</td>
<td>7:45 PM</td>
<td>78,285</td>
<td>...</td>
<td>5.6</td>
<td>10.7</td>
<td>12.90</td>
<td>81</td>
<td>Carlton</td>
<td>3.2</td>
<td>8.7</td>
<td>11.13</td>
<td>18.17</td>
<td>125</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2012R0103</td>
<td>2012</td>
<td>R1</td>
<td>2012-03-30</td>
<td>27.4</td>
<td>9.7</td>
<td>0.0</td>
<td>M.C.G.</td>
<td>7:50 PM</td>
<td>78,466</td>
<td>...</td>
<td>10.6</td>
<td>14.1</td>
<td>20.17</td>
<td>137</td>
<td>Collingwood</td>
<td>2.7</td>
<td>7.9</td>
<td>12.16</td>
<td>16.19</td>
<td>115</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2012R0104</td>
<td>2012</td>
<td>R1</td>
<td>2012-03-31</td>
<td>29.1</td>
<td>15.1</td>
<td>0.6</td>
<td>M.C.G.</td>
<td>1:45 PM</td>
<td>33,473</td>
<td>...</td>
<td>7.4</td>
<td>8.8</td>
<td>11.12</td>
<td>78</td>
<td>Brisbane Lions</td>
<td>1.4</td>
<td>7.8</td>
<td>13.13</td>
<td>17.17</td>
<td>119</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2012R0105</td>
<td>2012</td>
<td>R1</td>
<td>2012-03-31</td>
<td>28.2</td>
<td>19.7</td>
<td>0.0</td>
<td>Carrara</td>
<td>3:45 PM</td>
<td>12,790</td>
<td>...</td>
<td>5.3</td>
<td>8.6</td>
<td>10.80</td>
<td>68</td>
<td>Adelaide</td>
<td>7.8</td>
<td>11.1</td>
<td>15.16</td>
<td>19.23</td>
<td>137</td>
</tr>
</tbody>
</table>

<p>5 rows × 22 columns</p>
</div>
</div>
</div>
<p>We will only keep the columns we need to avoid clutter</p>
<div id="cell-6" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>game_cols_to_keep <span class="op">=</span> [<span class="st">'Year'</span>, <span class="st">'Round'</span>, <span class="st">'HomeTeam'</span>, <span class="st">'HomeTeamScore'</span>, <span class="st">'AwayTeam'</span>, <span class="st">'AwayTeamScore'</span>]</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>game_df <span class="op">=</span> games[game_cols_to_keep]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>game_df.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Year</th>
<th data-quarto-table-cell-role="th">Round</th>
<th data-quarto-table-cell-role="th">HomeTeam</th>
<th data-quarto-table-cell-role="th">HomeTeamScore</th>
<th data-quarto-table-cell-role="th">AwayTeam</th>
<th data-quarto-table-cell-role="th">AwayTeamScore</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2012</td>
<td>R1</td>
<td>Greater Western Sydney</td>
<td>37</td>
<td>Sydney</td>
<td>100</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2012</td>
<td>R1</td>
<td>Richmond</td>
<td>81</td>
<td>Carlton</td>
<td>125</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2012</td>
<td>R1</td>
<td>Hawthorn</td>
<td>137</td>
<td>Collingwood</td>
<td>115</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2012</td>
<td>R1</td>
<td>Melbourne</td>
<td>78</td>
<td>Brisbane Lions</td>
<td>119</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2012</td>
<td>R1</td>
<td>Gold Coast</td>
<td>68</td>
<td>Adelaide</td>
<td>137</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-7" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>player_statistics <span class="op">=</span> pd.read_csv(<span class="st">'data/stats.csv'</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>player_statistics.head().columns</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>Index(['GameId', 'Team', 'Year', 'Round', 'PlayerId', 'DisplayName',
       'GameNumber', 'Disposals', 'Kicks', 'Marks', 'Handballs', 'Goals',
       'Behinds', 'HitOuts', 'Tackles', 'Rebounds', 'Inside50s', 'Clearances',
       'Clangers', 'Frees', 'FreesAgainst', 'BrownlowVotes',
       'ContestedPossessions', 'UncontestedPossessions', 'ContestedMarks',
       'MarksInside50', 'OnePercenters', 'Bounces', 'GoalAssists', '%Played',
       'Subs'],
      dtype='object')</code></pre>
</div>
</div>
<p>The model will not analyse individual player performances, we just want team averages for each year to form a basis for ‘attack’ and ‘defense’ latent variables. Goals, goal assists and behinds will correlate too strongly with the game scores and will not provide any extra information for the model so they will be dropped. Disposals will be dropped as they are a linear combination of kicks and handballs. Variables %Played, Brownlow Votes and Subs will not be used either. These stats will be sorted into offensive and defensive metrics which is how they will be read into the model</p>
<div id="cell-9" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>cols_to_keep <span class="op">=</span> [<span class="st">'Team'</span>, <span class="st">'Year'</span>, <span class="st">'Round'</span>,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>       <span class="st">'Disposals'</span>, <span class="st">'Kicks'</span>, <span class="st">'Marks'</span>, <span class="st">'Handballs'</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>       <span class="st">'HitOuts'</span>, <span class="st">'Tackles'</span>, <span class="st">'Rebounds'</span>, <span class="st">'Inside50s'</span>, <span class="st">'Clearances'</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>       <span class="st">'Clangers'</span>, <span class="st">'Frees'</span>, <span class="st">'FreesAgainst'</span>, <span class="st">'ContestedPossessions'</span>, <span class="st">'UncontestedPossessions'</span>, <span class="st">'ContestedMarks'</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>       <span class="st">'MarksInside50'</span>, <span class="st">'OnePercenters'</span>, <span class="st">'Bounces'</span>]</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>team_stats_long <span class="op">=</span> player_statistics[cols_to_keep]</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>rounds_to_keep <span class="op">=</span> [<span class="st">'R'</span> <span class="op">+</span> <span class="bu">str</span>(i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">25</span>)] <span class="co">#removing finals for simplicity</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>team_stats_long <span class="op">=</span> team_stats_long[team_stats_long[<span class="st">'Round'</span>].isin(rounds_to_keep)]</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>team_stats_long.drop(<span class="st">'Round'</span>, axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>team_stats <span class="op">=</span> team_stats_long.groupby([<span class="st">'Team'</span>, <span class="st">'Year'</span>]).<span class="bu">sum</span>().sort_values([<span class="st">'Year'</span>, <span class="st">'Team'</span>]).reset_index()</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>team_stats.head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Team</th>
<th data-quarto-table-cell-role="th">Year</th>
<th data-quarto-table-cell-role="th">Disposals</th>
<th data-quarto-table-cell-role="th">Kicks</th>
<th data-quarto-table-cell-role="th">Marks</th>
<th data-quarto-table-cell-role="th">Handballs</th>
<th data-quarto-table-cell-role="th">HitOuts</th>
<th data-quarto-table-cell-role="th">Tackles</th>
<th data-quarto-table-cell-role="th">Rebounds</th>
<th data-quarto-table-cell-role="th">Inside50s</th>
<th data-quarto-table-cell-role="th">Clearances</th>
<th data-quarto-table-cell-role="th">Clangers</th>
<th data-quarto-table-cell-role="th">Frees</th>
<th data-quarto-table-cell-role="th">FreesAgainst</th>
<th data-quarto-table-cell-role="th">ContestedPossessions</th>
<th data-quarto-table-cell-role="th">UncontestedPossessions</th>
<th data-quarto-table-cell-role="th">ContestedMarks</th>
<th data-quarto-table-cell-role="th">MarksInside50</th>
<th data-quarto-table-cell-role="th">OnePercenters</th>
<th data-quarto-table-cell-role="th">Bounces</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Adelaide</td>
<td>2012</td>
<td>7709</td>
<td>4793</td>
<td>1969</td>
<td>2916</td>
<td>981</td>
<td>1304</td>
<td>736</td>
<td>1163</td>
<td>911</td>
<td>944</td>
<td>373</td>
<td>397</td>
<td>3316</td>
<td>4341</td>
<td>283</td>
<td>304</td>
<td>1032</td>
<td>129</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Brisbane Lions</td>
<td>2012</td>
<td>7716</td>
<td>4403</td>
<td>1890</td>
<td>3313</td>
<td>749</td>
<td>1393</td>
<td>817</td>
<td>1048</td>
<td>808</td>
<td>1097</td>
<td>398</td>
<td>446</td>
<td>3086</td>
<td>4595</td>
<td>204</td>
<td>218</td>
<td>1230</td>
<td>116</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Carlton</td>
<td>2012</td>
<td>7853</td>
<td>4625</td>
<td>1975</td>
<td>3228</td>
<td>937</td>
<td>1520</td>
<td>651</td>
<td>1165</td>
<td>867</td>
<td>986</td>
<td>398</td>
<td>419</td>
<td>3131</td>
<td>4648</td>
<td>230</td>
<td>294</td>
<td>1128</td>
<td>272</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Collingwood</td>
<td>2012</td>
<td>8198</td>
<td>4823</td>
<td>2017</td>
<td>3375</td>
<td>785</td>
<td>1405</td>
<td>784</td>
<td>1159</td>
<td>842</td>
<td>946</td>
<td>366</td>
<td>365</td>
<td>3218</td>
<td>4933</td>
<td>270</td>
<td>271</td>
<td>1088</td>
<td>265</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>Essendon</td>
<td>2012</td>
<td>7765</td>
<td>4666</td>
<td>2003</td>
<td>3099</td>
<td>942</td>
<td>1345</td>
<td>774</td>
<td>1225</td>
<td>798</td>
<td>1027</td>
<td>418</td>
<td>403</td>
<td>3147</td>
<td>4600</td>
<td>261</td>
<td>252</td>
<td>1094</td>
<td>168</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-10" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>team_stats.drop([<span class="st">'Team'</span>, <span class="st">'Year'</span>], axis <span class="op">=</span> <span class="dv">1</span>).corr()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Disposals</th>
<th data-quarto-table-cell-role="th">Kicks</th>
<th data-quarto-table-cell-role="th">Marks</th>
<th data-quarto-table-cell-role="th">Handballs</th>
<th data-quarto-table-cell-role="th">HitOuts</th>
<th data-quarto-table-cell-role="th">Tackles</th>
<th data-quarto-table-cell-role="th">Rebounds</th>
<th data-quarto-table-cell-role="th">Inside50s</th>
<th data-quarto-table-cell-role="th">Clearances</th>
<th data-quarto-table-cell-role="th">Clangers</th>
<th data-quarto-table-cell-role="th">Frees</th>
<th data-quarto-table-cell-role="th">FreesAgainst</th>
<th data-quarto-table-cell-role="th">ContestedPossessions</th>
<th data-quarto-table-cell-role="th">UncontestedPossessions</th>
<th data-quarto-table-cell-role="th">ContestedMarks</th>
<th data-quarto-table-cell-role="th">MarksInside50</th>
<th data-quarto-table-cell-role="th">OnePercenters</th>
<th data-quarto-table-cell-role="th">Bounces</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">Disposals</th>
<td>1.000000</td>
<td>0.910351</td>
<td>0.839811</td>
<td>0.903049</td>
<td>0.571414</td>
<td>0.789255</td>
<td>0.610808</td>
<td>0.862372</td>
<td>0.807113</td>
<td>0.582055</td>
<td>0.680007</td>
<td>0.596433</td>
<td>0.901822</td>
<td>0.969491</td>
<td>0.637916</td>
<td>0.727281</td>
<td>0.665613</td>
<td>0.337098</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Kicks</th>
<td>0.910351</td>
<td>1.000000</td>
<td>0.911171</td>
<td>0.644332</td>
<td>0.536117</td>
<td>0.665195</td>
<td>0.705629</td>
<td>0.862463</td>
<td>0.815880</td>
<td>0.675174</td>
<td>0.701558</td>
<td>0.627580</td>
<td>0.866330</td>
<td>0.836495</td>
<td>0.694894</td>
<td>0.729139</td>
<td>0.719775</td>
<td>0.266493</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Marks</th>
<td>0.839811</td>
<td>0.911171</td>
<td>1.000000</td>
<td>0.606178</td>
<td>0.483379</td>
<td>0.552818</td>
<td>0.579840</td>
<td>0.695572</td>
<td>0.652370</td>
<td>0.542559</td>
<td>0.608759</td>
<td>0.525762</td>
<td>0.675559</td>
<td>0.849695</td>
<td>0.640515</td>
<td>0.664675</td>
<td>0.514708</td>
<td>0.274344</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Handballs</th>
<td>0.903049</td>
<td>0.644332</td>
<td>0.606178</td>
<td>1.000000</td>
<td>0.499480</td>
<td>0.768061</td>
<td>0.396336</td>
<td>0.698426</td>
<td>0.644660</td>
<td>0.374812</td>
<td>0.528437</td>
<td>0.450781</td>
<td>0.767312</td>
<td>0.923328</td>
<td>0.457571</td>
<td>0.587168</td>
<td>0.482929</td>
<td>0.346332</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">HitOuts</th>
<td>0.571414</td>
<td>0.536117</td>
<td>0.483379</td>
<td>0.499480</td>
<td>1.000000</td>
<td>0.600626</td>
<td>0.285175</td>
<td>0.512277</td>
<td>0.708788</td>
<td>0.204307</td>
<td>0.452939</td>
<td>0.359242</td>
<td>0.634800</td>
<td>0.503586</td>
<td>0.488756</td>
<td>0.422544</td>
<td>0.311608</td>
<td>0.214313</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Tackles</th>
<td>0.789255</td>
<td>0.665195</td>
<td>0.552818</td>
<td>0.768061</td>
<td>0.600626</td>
<td>1.000000</td>
<td>0.424493</td>
<td>0.709848</td>
<td>0.755650</td>
<td>0.357743</td>
<td>0.545966</td>
<td>0.552527</td>
<td>0.825077</td>
<td>0.720601</td>
<td>0.511500</td>
<td>0.590045</td>
<td>0.587356</td>
<td>0.351427</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Rebounds</th>
<td>0.610808</td>
<td>0.705629</td>
<td>0.579840</td>
<td>0.396336</td>
<td>0.285175</td>
<td>0.424493</td>
<td>1.000000</td>
<td>0.483696</td>
<td>0.531633</td>
<td>0.841321</td>
<td>0.583252</td>
<td>0.646899</td>
<td>0.583790</td>
<td>0.525661</td>
<td>0.421032</td>
<td>0.278173</td>
<td>0.582944</td>
<td>0.027090</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Inside50s</th>
<td>0.862372</td>
<td>0.862463</td>
<td>0.695572</td>
<td>0.698426</td>
<td>0.512277</td>
<td>0.709848</td>
<td>0.483696</td>
<td>1.000000</td>
<td>0.797782</td>
<td>0.567436</td>
<td>0.623790</td>
<td>0.576188</td>
<td>0.891526</td>
<td>0.768696</td>
<td>0.675053</td>
<td>0.862492</td>
<td>0.699808</td>
<td>0.292668</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Clearances</th>
<td>0.807113</td>
<td>0.815880</td>
<td>0.652370</td>
<td>0.644660</td>
<td>0.708788</td>
<td>0.755650</td>
<td>0.531633</td>
<td>0.797782</td>
<td>1.000000</td>
<td>0.435312</td>
<td>0.626129</td>
<td>0.558520</td>
<td>0.877533</td>
<td>0.698812</td>
<td>0.559309</td>
<td>0.633563</td>
<td>0.673268</td>
<td>0.357811</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Clangers</th>
<td>0.582055</td>
<td>0.675174</td>
<td>0.542559</td>
<td>0.374812</td>
<td>0.204307</td>
<td>0.357743</td>
<td>0.841321</td>
<td>0.567436</td>
<td>0.435312</td>
<td>1.000000</td>
<td>0.614480</td>
<td>0.735799</td>
<td>0.557747</td>
<td>0.504727</td>
<td>0.412057</td>
<td>0.387999</td>
<td>0.579595</td>
<td>-0.118877</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Frees</th>
<td>0.680007</td>
<td>0.701558</td>
<td>0.608759</td>
<td>0.528437</td>
<td>0.452939</td>
<td>0.545966</td>
<td>0.583252</td>
<td>0.623790</td>
<td>0.626129</td>
<td>0.614480</td>
<td>1.000000</td>
<td>0.703283</td>
<td>0.712946</td>
<td>0.603252</td>
<td>0.580819</td>
<td>0.463295</td>
<td>0.545038</td>
<td>0.106843</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">FreesAgainst</th>
<td>0.596433</td>
<td>0.627580</td>
<td>0.525762</td>
<td>0.450781</td>
<td>0.359242</td>
<td>0.552527</td>
<td>0.646899</td>
<td>0.576188</td>
<td>0.558520</td>
<td>0.735799</td>
<td>0.703283</td>
<td>1.000000</td>
<td>0.639463</td>
<td>0.516929</td>
<td>0.477228</td>
<td>0.418754</td>
<td>0.575669</td>
<td>0.123125</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">ContestedPossessions</th>
<td>0.901822</td>
<td>0.866330</td>
<td>0.675559</td>
<td>0.767312</td>
<td>0.634800</td>
<td>0.825077</td>
<td>0.583790</td>
<td>0.891526</td>
<td>0.877533</td>
<td>0.557747</td>
<td>0.712946</td>
<td>0.639463</td>
<td>1.000000</td>
<td>0.778332</td>
<td>0.714830</td>
<td>0.709877</td>
<td>0.723629</td>
<td>0.304789</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">UncontestedPossessions</th>
<td>0.969491</td>
<td>0.836495</td>
<td>0.849695</td>
<td>0.923328</td>
<td>0.503586</td>
<td>0.720601</td>
<td>0.525661</td>
<td>0.768696</td>
<td>0.698812</td>
<td>0.504727</td>
<td>0.603252</td>
<td>0.516929</td>
<td>0.778332</td>
<td>1.000000</td>
<td>0.546597</td>
<td>0.677963</td>
<td>0.562319</td>
<td>0.339456</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">ContestedMarks</th>
<td>0.637916</td>
<td>0.694894</td>
<td>0.640515</td>
<td>0.457571</td>
<td>0.488756</td>
<td>0.511500</td>
<td>0.421032</td>
<td>0.675053</td>
<td>0.559309</td>
<td>0.412057</td>
<td>0.580819</td>
<td>0.477228</td>
<td>0.714830</td>
<td>0.546597</td>
<td>1.000000</td>
<td>0.671974</td>
<td>0.416370</td>
<td>0.155026</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">MarksInside50</th>
<td>0.727281</td>
<td>0.729139</td>
<td>0.664675</td>
<td>0.587168</td>
<td>0.422544</td>
<td>0.590045</td>
<td>0.278173</td>
<td>0.862492</td>
<td>0.633563</td>
<td>0.387999</td>
<td>0.463295</td>
<td>0.418754</td>
<td>0.709877</td>
<td>0.677963</td>
<td>0.671974</td>
<td>1.000000</td>
<td>0.472556</td>
<td>0.295628</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">OnePercenters</th>
<td>0.665613</td>
<td>0.719775</td>
<td>0.514708</td>
<td>0.482929</td>
<td>0.311608</td>
<td>0.587356</td>
<td>0.582944</td>
<td>0.699808</td>
<td>0.673268</td>
<td>0.579595</td>
<td>0.545038</td>
<td>0.575669</td>
<td>0.723629</td>
<td>0.562319</td>
<td>0.416370</td>
<td>0.472556</td>
<td>1.000000</td>
<td>0.218094</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Bounces</th>
<td>0.337098</td>
<td>0.266493</td>
<td>0.274344</td>
<td>0.346332</td>
<td>0.214313</td>
<td>0.351427</td>
<td>0.027090</td>
<td>0.292668</td>
<td>0.357811</td>
<td>-0.118877</td>
<td>0.106843</td>
<td>0.123125</td>
<td>0.304789</td>
<td>0.339456</td>
<td>0.155026</td>
<td>0.295628</td>
<td>0.218094</td>
<td>1.000000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Clearly a lot of the stats are highly correlated which will justify the use of PCA on the dataset</p>
<div id="cell-12" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pca(team_statistics_dataset):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    teams <span class="op">=</span> team_statistics_dataset[<span class="st">'Team'</span>]</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    years <span class="op">=</span> team_statistics_dataset[<span class="st">'Year'</span>]</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    team_stats <span class="op">=</span> team_statistics_dataset.drop([<span class="st">'Team'</span>, <span class="st">'Year'</span>], axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize the data</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    team_stats_scaled <span class="op">=</span> scaler.fit_transform(team_stats)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit the PCA model</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    pca <span class="op">=</span> PCA(n_components <span class="op">=</span> <span class="fl">0.95</span>) <span class="co"># To retain 95% of the variance</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    new_data <span class="op">=</span> pca.fit_transform(team_stats_scaled)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format the pca data into a dataframe</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    pca_data <span class="op">=</span> pd.DataFrame(new_data, columns <span class="op">=</span> [<span class="st">'PC'</span> <span class="op">+</span> <span class="bu">str</span>(i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, new_data.shape[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span>)])</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    pca_data[<span class="st">'Team'</span>] <span class="op">=</span> teams</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    pca_data[<span class="st">'Year'</span>] <span class="op">=</span> years</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    final_columns <span class="op">=</span> [<span class="st">'Team'</span>, <span class="st">'Year'</span>] <span class="op">+</span> [<span class="st">'PC'</span> <span class="op">+</span> <span class="bu">str</span>(i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, new_data.shape[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">1</span>)]</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    pca_data <span class="op">=</span> pca_data[final_columns]</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pca_data</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>PCA_stats <span class="op">=</span> pca(team_stats)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>PCA_stats</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Team</th>
<th data-quarto-table-cell-role="th">Year</th>
<th data-quarto-table-cell-role="th">PC1</th>
<th data-quarto-table-cell-role="th">PC2</th>
<th data-quarto-table-cell-role="th">PC3</th>
<th data-quarto-table-cell-role="th">PC4</th>
<th data-quarto-table-cell-role="th">PC5</th>
<th data-quarto-table-cell-role="th">PC6</th>
<th data-quarto-table-cell-role="th">PC7</th>
<th data-quarto-table-cell-role="th">PC8</th>
<th data-quarto-table-cell-role="th">PC9</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Adelaide</td>
<td>2012</td>
<td>0.658792</td>
<td>-0.984249</td>
<td>2.014072</td>
<td>0.701787</td>
<td>-1.409568</td>
<td>-0.106361</td>
<td>-0.790861</td>
<td>-0.232091</td>
<td>0.094558</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Brisbane Lions</td>
<td>2012</td>
<td>-0.074597</td>
<td>1.021397</td>
<td>-1.181794</td>
<td>0.554890</td>
<td>-0.257283</td>
<td>-0.932035</td>
<td>-0.211187</td>
<td>0.481955</td>
<td>-0.058517</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Carlton</td>
<td>2012</td>
<td>0.931581</td>
<td>-1.997261</td>
<td>-0.396465</td>
<td>0.516284</td>
<td>-1.557807</td>
<td>-0.147811</td>
<td>0.164286</td>
<td>-0.080944</td>
<td>-0.745708</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Collingwood</td>
<td>2012</td>
<td>0.936581</td>
<td>-1.732937</td>
<td>-0.196525</td>
<td>-0.739634</td>
<td>-1.171677</td>
<td>0.274340</td>
<td>-0.534968</td>
<td>0.162109</td>
<td>1.026016</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>Essendon</td>
<td>2012</td>
<td>0.687605</td>
<td>-0.341206</td>
<td>0.705276</td>
<td>0.461726</td>
<td>-0.934017</td>
<td>0.173532</td>
<td>-0.230057</td>
<td>0.392014</td>
<td>0.089700</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">211</th>
<td>Richmond</td>
<td>2023</td>
<td>2.337820</td>
<td>1.487335</td>
<td>-0.185844</td>
<td>-0.374654</td>
<td>-0.952431</td>
<td>-0.078276</td>
<td>-1.424848</td>
<td>-1.872549</td>
<td>0.505720</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">212</th>
<td>St Kilda</td>
<td>2023</td>
<td>2.673075</td>
<td>1.001132</td>
<td>-0.171502</td>
<td>-1.805777</td>
<td>1.210700</td>
<td>0.351236</td>
<td>-0.825929</td>
<td>0.307152</td>
<td>0.317417</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">213</th>
<td>Sydney</td>
<td>2023</td>
<td>2.363447</td>
<td>1.790445</td>
<td>-0.776916</td>
<td>-0.237490</td>
<td>-0.693070</td>
<td>-0.835622</td>
<td>-0.132525</td>
<td>-0.307637</td>
<td>0.319752</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">214</th>
<td>West Coast</td>
<td>2023</td>
<td>-0.372962</td>
<td>1.529812</td>
<td>-1.414003</td>
<td>-0.161040</td>
<td>1.629578</td>
<td>0.757098</td>
<td>-0.364209</td>
<td>-0.715334</td>
<td>-0.339356</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">215</th>
<td>Western Bulldogs</td>
<td>2023</td>
<td>2.492283</td>
<td>0.072285</td>
<td>-0.395208</td>
<td>0.147377</td>
<td>0.104553</td>
<td>-1.350135</td>
<td>-1.755657</td>
<td>-0.165438</td>
<td>-0.122689</td>
</tr>
</tbody>
</table>

<p>216 rows × 11 columns</p>
</div>
</div>
</div>
<p>We will create a data class to organise all constant data for the pymc model, including variables that will inform the parameters of our prior distributions. The model will only analyse one year at a time so the season will be a parameter for the data class</p>
<div id="cell-14" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Data:</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, game_df, team_stats_df, season, rounds <span class="op">=</span> <span class="dv">23</span>):</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>        rounds <span class="op">=</span> [<span class="st">'R'</span> <span class="op">+</span> <span class="bu">str</span>(i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, rounds <span class="op">+</span> <span class="dv">1</span>)]</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.game_df <span class="op">=</span> game_df.loc[(game_df[<span class="st">'Year'</span>] <span class="op">==</span> season) <span class="op">&amp;</span> (game_df[<span class="st">'Round'</span>].isin(rounds))].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._add_winner_column()</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.team_stats_df <span class="op">=</span> team_stats_df.loc[team_stats_df[<span class="st">'Year'</span>] <span class="op">==</span> season].reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._infer_statistics()</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.coords <span class="op">=</span> {<span class="st">"team"</span>: <span class="va">self</span>.teams,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"metric"</span>: <span class="va">self</span>.team_stats_df.drop([<span class="st">'Team'</span>, <span class="st">'Year'</span>], axis <span class="op">=</span> <span class="dv">1</span>).columns,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"match"</span>: <span class="va">self</span>.game_df.index}</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._priors()</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _infer_statistics(<span class="va">self</span>):</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.home_idx, <span class="va">self</span>.teams <span class="op">=</span> pd.factorize(<span class="va">self</span>.game_df[<span class="st">"HomeTeam"</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.away_idx, _ <span class="op">=</span> pd.factorize(<span class="va">self</span>.game_df[<span class="st">"AwayTeam"</span>], sort<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _priors(<span class="va">self</span>):</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        ratio <span class="op">=</span> <span class="va">self</span>.game_df[<span class="st">"HomeTeamScore"</span>] <span class="op">/</span> <span class="va">self</span>.game_df[<span class="st">"AwayTeamScore"</span>]</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.avg_home_point_advantage <span class="op">=</span> ratio.mean()</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.home_point_advantage_std <span class="op">=</span> ratio.std()</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        all_scores <span class="op">=</span> np.array(pd.concat([<span class="va">self</span>.game_df[<span class="st">"HomeTeamScore"</span>], <span class="va">self</span>.game_df[<span class="st">"AwayTeamScore"</span>]]))</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.avg_score <span class="op">=</span> np.mean(all_scores)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.score_std <span class="op">=</span> np.std(all_scores)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _add_winner_column(<span class="va">self</span>):</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.game_df[<span class="st">"Winner"</span>] <span class="op">=</span> <span class="va">self</span>.game_df.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x[<span class="st">"HomeTeam"</span>] <span class="cf">if</span> x[<span class="st">"HomeTeamScore"</span>] <span class="op">&gt;</span> x[<span class="st">"AwayTeamScore"</span>] <span class="cf">else</span> x[<span class="st">"AwayTeam"</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> Data(game_df, PCA_stats, <span class="dv">2017</span>, rounds <span class="op">=</span> <span class="dv">23</span>)</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The pymc model.</p>
<p>The model will attempt to learn latent attack and defense paramters for each team. These parameters will be formed by a linear regression of the team statistics variables, as well as a team specific intercept term to capture information that leads to a teams score that is not captured by the variables in team statistics.</p>
<p>The scoring is modelled by a normal distribution rather than a typical poisson distribution to better account for the higher spread in points scored</p>
<div id="cell-16" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_model(data):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pm.Model(coords <span class="op">=</span> data.coords) <span class="im">as</span> model:</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">#constant data</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        home_team <span class="op">=</span> pm.ConstantData(<span class="st">'home_team'</span>, data.home_idx, dims <span class="op">=</span> <span class="st">"match"</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        away_team <span class="op">=</span> pm.ConstantData(<span class="st">'away_team'</span>, data.away_idx, dims <span class="op">=</span> <span class="st">"match"</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>        team_statistics <span class="op">=</span> pm.ConstantData(<span class="st">'team_statistics'</span>, data.team_stats_df.drop([<span class="st">'Team'</span>, <span class="st">'Year'</span>], axis <span class="op">=</span> <span class="dv">1</span>).values, dims <span class="op">=</span> [<span class="st">"team"</span>, <span class="st">"metric"</span>])</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">#global model parameters</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        home_uncentered <span class="op">=</span> pm.Normal(<span class="st">'home_uncentered'</span>, mu <span class="op">=</span> <span class="dv">0</span>, sigma <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        home <span class="op">=</span> pm.Deterministic(<span class="st">'home'</span>, home_uncentered <span class="op">*</span> np.log(data.home_point_advantage_std) <span class="op">+</span> np.log(data.avg_home_point_advantage))</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        scoring_intercept_uncentered <span class="op">=</span> pm.Normal(<span class="st">'scoring_intercept_uncentered'</span>, mu <span class="op">=</span> <span class="dv">0</span>, sigma <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        scoring_intercept <span class="op">=</span> pm.Deterministic(<span class="st">'scoring_intercept'</span>, scoring_intercept_uncentered <span class="op">*</span> np.log(data.score_std) <span class="op">+</span> np.log(data.avg_score))</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">#team-specific model parameters</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        att_beta <span class="op">=</span> pm.ZeroSumNormal(<span class="st">'att_beta'</span>, sigma <span class="op">=</span> <span class="fl">0.05</span>, dims <span class="op">=</span> <span class="st">"metric"</span>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        offensive_intercept <span class="op">=</span> pm.Normal(<span class="st">'offensive_intercept'</span>, mu <span class="op">=</span> <span class="dv">0</span>, sigma <span class="op">=</span> <span class="dv">1</span>, dims<span class="op">=</span><span class="st">"team"</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        atts_star <span class="op">=</span> pm.Deterministic(<span class="st">'atts_star'</span>, pm.math.dot(att_beta, team_statistics.T) <span class="op">+</span> offensive_intercept, dims <span class="op">=</span> <span class="st">"team"</span>)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        def_beta <span class="op">=</span> pm.ZeroSumNormal(<span class="st">'def_beta'</span>, sigma <span class="op">=</span> <span class="fl">0.05</span>, dims <span class="op">=</span> <span class="st">"metric"</span>)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>        defensive_intercept <span class="op">=</span> pm.Normal(<span class="st">'defensive_intercept'</span>, mu <span class="op">=</span> <span class="dv">0</span>, sigma <span class="op">=</span> <span class="dv">1</span>, dims<span class="op">=</span><span class="st">"team"</span>)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        defs_star <span class="op">=</span> pm.Deterministic(<span class="st">'defs_star'</span>, pm.math.dot(def_beta, team_statistics.T) <span class="op">+</span> defensive_intercept, dims <span class="op">=</span> <span class="st">"team"</span>)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        atts <span class="op">=</span> pm.Deterministic(<span class="st">'atts'</span>, atts_star <span class="op">-</span> pt.mean(atts_star), dims <span class="op">=</span> <span class="st">"team"</span>)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        defs <span class="op">=</span> pm.Deterministic(<span class="st">'defs'</span>, defs_star <span class="op">-</span> pt.mean(defs_star), dims <span class="op">=</span> <span class="st">"team"</span>)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">#scoring</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        home_mu <span class="op">=</span> pt.exp(scoring_intercept <span class="op">+</span> home <span class="op">+</span> atts[home_team] <span class="op">-</span> defs[away_team])</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>        away_mu <span class="op">=</span> pt.exp(scoring_intercept <span class="op">+</span> atts[away_team] <span class="op">-</span> defs[home_team])</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>        sigma_uncentered <span class="op">=</span> pm.Exponential(<span class="st">"sigma_uncentered"</span>, scale <span class="op">=</span> <span class="dv">1</span>, dims <span class="op">=</span> <span class="st">"team"</span>)</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        sigma <span class="op">=</span> pm.Deterministic(<span class="st">"sigma"</span>, sigma_uncentered <span class="op">*</span> np.log(data.score_std), dims <span class="op">=</span> <span class="st">"team"</span>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>        home_points <span class="op">=</span> pm.Normal(<span class="st">"home_points"</span>,</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>                                mu <span class="op">=</span> home_mu,</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>                                sigma <span class="op">=</span> sigma[home_team],</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>                                observed <span class="op">=</span> data.game_df[<span class="st">"HomeTeamScore"</span>],</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>                                dims <span class="op">=</span> <span class="st">"match"</span>)</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>        away_points <span class="op">=</span> pm.Normal(<span class="st">"away_points"</span>,</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>                                mu <span class="op">=</span> away_mu,</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>                                sigma <span class="op">=</span> sigma[away_team],</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>                                observed <span class="op">=</span> data.game_df[<span class="st">"AwayTeamScore"</span>],</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>                                dims <span class="op">=</span> <span class="st">"match"</span>)</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>        trace <span class="op">=</span> pm.sample(draws <span class="op">=</span> <span class="dv">1000</span>,</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>                        tune <span class="op">=</span> <span class="dv">5000</span>,</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>                        chains <span class="op">=</span> <span class="dv">4</span>,</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>                        cores <span class="op">=</span> <span class="dv">4</span>,)</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> trace</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>trace <span class="op">=</span> create_model(data)</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>az.to_netcdf(trace, <span class="st">'trace.nc'</span>) <span class="co">#save trace for later use</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/jedtoner1/Desktop/Developer/AFLSeason/AFL/lib/python3.12/site-packages/pymc/data.py:274: FutureWarning: ConstantData is deprecated. All Data variables are now mutable. Use Data instead.
  warnings.warn(
/Users/jedtoner1/Desktop/Developer/AFLSeason/AFL/lib/python3.12/site-packages/pymc/data.py:274: FutureWarning: ConstantData is deprecated. All Data variables are now mutable. Use Data instead.
  warnings.warn(
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [home_uncentered, scoring_intercept_uncentered, att_beta, offensive_intercept, def_beta, defensive_intercept, sigma_uncentered]</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">/Users/jedtoner1/Desktop/Developer/AFLSeason/AFL/lib/python3.12/site-packages/rich/live.py:231: UserWarning: 
install "ipywidgets" for Jupyter support
  warnings.warn('install "ipywidgets" for Jupyter support')
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling 4 chains for 5_000 tune and 1_000 draw iterations (20_000 + 4_000 draws total) took 53 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>'trace.nc'</code></pre>
</div>
</div>
<p>We will look at plots and diagnostics to see if our model has converged</p>
<div id="cell-18" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>trace <span class="op">=</span> az.from_netcdf(<span class="st">'trace.nc'</span>) <span class="co">#load model trace</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-19" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>az.plot_trace(trace, var_names <span class="op">=</span> [<span class="st">"home"</span>, <span class="st">"scoring_intercept"</span>])<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="afl_files/figure-html/cell-12-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-20" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>az.summary(trace, var_names <span class="op">=</span> [<span class="st">"atts"</span>, <span class="st">"defs"</span>], kind <span class="op">=</span> <span class="st">"diagnostics"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">atts[Adelaide]</th>
<td>0.001</td>
<td>0.001</td>
<td>4116.0</td>
<td>3077.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">atts[Brisbane Lions]</th>
<td>0.001</td>
<td>0.000</td>
<td>4238.0</td>
<td>3662.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">atts[Carlton]</th>
<td>0.001</td>
<td>0.000</td>
<td>3784.0</td>
<td>3666.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">atts[Collingwood]</th>
<td>0.001</td>
<td>0.000</td>
<td>4000.0</td>
<td>3781.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">atts[Essendon]</th>
<td>0.001</td>
<td>0.001</td>
<td>3959.0</td>
<td>3120.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">atts[Fremantle]</th>
<td>0.001</td>
<td>0.001</td>
<td>3855.0</td>
<td>2945.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">atts[Geelong]</th>
<td>0.001</td>
<td>0.000</td>
<td>4149.0</td>
<td>3120.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">atts[Gold Coast]</th>
<td>0.001</td>
<td>0.001</td>
<td>3879.0</td>
<td>2968.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">atts[Greater Western Sydney]</th>
<td>0.001</td>
<td>0.000</td>
<td>4075.0</td>
<td>3086.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">atts[Hawthorn]</th>
<td>0.001</td>
<td>0.001</td>
<td>4026.0</td>
<td>3041.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">atts[Melbourne]</th>
<td>0.001</td>
<td>0.001</td>
<td>4067.0</td>
<td>3369.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">atts[North Melbourne]</th>
<td>0.001</td>
<td>0.001</td>
<td>4162.0</td>
<td>3181.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">atts[Port Adelaide]</th>
<td>0.001</td>
<td>0.001</td>
<td>4197.0</td>
<td>3354.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">atts[Richmond]</th>
<td>0.001</td>
<td>0.001</td>
<td>4004.0</td>
<td>3142.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">atts[St Kilda]</th>
<td>0.001</td>
<td>0.001</td>
<td>4029.0</td>
<td>2895.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">atts[Sydney]</th>
<td>0.001</td>
<td>0.000</td>
<td>4207.0</td>
<td>3395.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">atts[West Coast]</th>
<td>0.001</td>
<td>0.000</td>
<td>4271.0</td>
<td>3575.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">atts[Western Bulldogs]</th>
<td>0.001</td>
<td>0.001</td>
<td>4169.0</td>
<td>3528.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">defs[Adelaide]</th>
<td>0.001</td>
<td>0.001</td>
<td>4017.0</td>
<td>3264.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">defs[Brisbane Lions]</th>
<td>0.001</td>
<td>0.000</td>
<td>4118.0</td>
<td>3178.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">defs[Carlton]</th>
<td>0.001</td>
<td>0.001</td>
<td>4086.0</td>
<td>3370.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">defs[Collingwood]</th>
<td>0.001</td>
<td>0.001</td>
<td>4281.0</td>
<td>3189.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">defs[Essendon]</th>
<td>0.001</td>
<td>0.001</td>
<td>4123.0</td>
<td>3480.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">defs[Fremantle]</th>
<td>0.001</td>
<td>0.000</td>
<td>4102.0</td>
<td>3645.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">defs[Geelong]</th>
<td>0.001</td>
<td>0.001</td>
<td>4167.0</td>
<td>3332.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">defs[Gold Coast]</th>
<td>0.001</td>
<td>0.000</td>
<td>3927.0</td>
<td>3715.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">defs[Greater Western Sydney]</th>
<td>0.001</td>
<td>0.001</td>
<td>4241.0</td>
<td>3154.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">defs[Hawthorn]</th>
<td>0.001</td>
<td>0.001</td>
<td>4313.0</td>
<td>3402.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">defs[Melbourne]</th>
<td>0.001</td>
<td>0.001</td>
<td>3605.0</td>
<td>3504.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">defs[North Melbourne]</th>
<td>0.001</td>
<td>0.000</td>
<td>4175.0</td>
<td>3479.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">defs[Port Adelaide]</th>
<td>0.001</td>
<td>0.001</td>
<td>4058.0</td>
<td>3383.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">defs[Richmond]</th>
<td>0.001</td>
<td>0.001</td>
<td>4229.0</td>
<td>3594.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">defs[St Kilda]</th>
<td>0.001</td>
<td>0.001</td>
<td>4420.0</td>
<td>3620.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">defs[Sydney]</th>
<td>0.001</td>
<td>0.001</td>
<td>4127.0</td>
<td>3138.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">defs[West Coast]</th>
<td>0.001</td>
<td>0.001</td>
<td>3775.0</td>
<td>2900.0</td>
<td>1.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">defs[Western Bulldogs]</th>
<td>0.001</td>
<td>0.001</td>
<td>4031.0</td>
<td>3241.0</td>
<td>1.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Our model has converged and Rhat looks good.</p>
<p>We will now inspect the parameters to see if they match up with industry knowledge. The 2017 season saw Adelaide, Richmond, Geelong do well and Carlton, Gold Coast and Brisbane do poorly</p>
<div id="cell-22" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>trace.posterior[<span class="st">"atts"</span>].mean(dim <span class="op">=</span> [<span class="st">"chain"</span>, <span class="st">"draw"</span>]).to_pandas().sort_values()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>team
Carlton                  -0.205138
Fremantle                -0.193383
Gold Coast               -0.112112
Western Bulldogs         -0.057072
Hawthorn                 -0.051424
Brisbane Lions           -0.020016
St Kilda                 -0.013627
Collingwood              -0.000820
Richmond                  0.000670
North Melbourne           0.005767
West Coast                0.007059
Melbourne                 0.024026
Essendon                  0.060009
Sydney                    0.070289
Greater Western Sydney    0.087530
Port Adelaide             0.089931
Geelong                   0.093058
Adelaide                  0.215254
dtype: float64</code></pre>
</div>
</div>
<div id="cell-23" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>trace.posterior[<span class="st">"defs"</span>].mean(dim <span class="op">=</span> [<span class="st">"chain"</span>, <span class="st">"draw"</span>]).to_pandas().sort_values()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>team
Brisbane Lions           -0.261642
Gold Coast               -0.182726
North Melbourne          -0.161610
Fremantle                -0.086852
Carlton                  -0.034198
Essendon                 -0.024289
St Kilda                 -0.017908
Hawthorn                 -0.010141
Collingwood               0.002900
Melbourne                 0.005190
Western Bulldogs          0.033926
West Coast                0.058964
Geelong                   0.087093
Greater Western Sydney    0.088482
Adelaide                  0.091281
Sydney                    0.132509
Richmond                  0.135809
Port Adelaide             0.143211
dtype: float64</code></pre>
</div>
</div>
<p>So the model parameters recover what we already knew about the 2017 season. Lets plot the latent variables for each team</p>
<div id="cell-25" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>trace_hdi <span class="op">=</span> az.hdi(trace)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>ax.scatter(data.teams, trace.posterior[<span class="st">"atts"</span>].median(dim<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>)), color<span class="op">=</span><span class="st">"C0"</span>, alpha<span class="op">=</span><span class="dv">1</span>, s<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>ax.vlines(</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    data.teams,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    trace_hdi[<span class="st">"atts"</span>].sel({<span class="st">"hdi"</span>: <span class="st">"lower"</span>}),</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    trace_hdi[<span class="st">"atts"</span>].sel({<span class="st">"hdi"</span>: <span class="st">"higher"</span>}),</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.6</span>,</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    lw<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"C0"</span>,</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(<span class="bu">range</span>(<span class="bu">len</span>(data.teams)))</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(data.teams, rotation<span class="op">=</span><span class="dv">60</span>)<span class="op">;</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Teams"</span>)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Posterior Attack Strength"</span>)</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"HDI of Team-wise Attack Strength"</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="afl_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-26" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>trace_hdi <span class="op">=</span> az.hdi(trace)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>ax.scatter(data.teams, trace.posterior[<span class="st">"defs"</span>].median(dim<span class="op">=</span>(<span class="st">"chain"</span>, <span class="st">"draw"</span>)), color<span class="op">=</span><span class="st">"C0"</span>, alpha<span class="op">=</span><span class="dv">1</span>, s<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>ax.vlines(</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    data.teams,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    trace_hdi[<span class="st">"defs"</span>].sel({<span class="st">"hdi"</span>: <span class="st">"lower"</span>}),</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    trace_hdi[<span class="st">"defs"</span>].sel({<span class="st">"hdi"</span>: <span class="st">"higher"</span>}),</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.6</span>,</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    lw<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">"C0"</span>,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(<span class="bu">range</span>(<span class="bu">len</span>(data.teams)))</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(data.teams, rotation<span class="op">=</span><span class="dv">60</span>)<span class="op">;</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Teams"</span>)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Posterior Attack Strength"</span>)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"HDI of Team-wise Attack Strength"</span>)<span class="op">;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="afl_files/figure-html/cell-17-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We will build functions to predict the outcome of games and probability of winning</p>
<div id="cell-28" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_game(home_team, away_team, trace, variance <span class="op">=</span> <span class="va">True</span>):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    post <span class="op">=</span> trace.posterior</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    home <span class="op">=</span> post[<span class="st">"home"</span>].mean()</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    scoring_intercept <span class="op">=</span> post[<span class="st">"scoring_intercept"</span>].mean()</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    atts <span class="op">=</span> post[<span class="st">"atts"</span>].mean(dim <span class="op">=</span> [<span class="st">"chain"</span>, <span class="st">"draw"</span>])</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    defs <span class="op">=</span> post[<span class="st">"defs"</span>].mean(dim <span class="op">=</span> [<span class="st">"chain"</span>, <span class="st">"draw"</span>])</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    home_mu <span class="op">=</span> np.exp(scoring_intercept <span class="op">+</span> home <span class="op">+</span> atts.sel(team <span class="op">=</span> home_team) <span class="op">-</span> defs.sel(team <span class="op">=</span> away_team)).values</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    away_mu <span class="op">=</span> np.exp(scoring_intercept <span class="op">+</span> atts.sel(team <span class="op">=</span> away_team) <span class="op">-</span> defs.sel(team <span class="op">=</span> home_team)).values</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> variance:</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        sigma <span class="op">=</span> post[<span class="st">"sigma"</span>].mean(dim <span class="op">=</span> [<span class="st">"chain"</span>, <span class="st">"draw"</span>]).sel(team <span class="op">=</span> home_team)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>        home_points <span class="op">=</span> np.random.normal(home_mu, sigma)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>        sigma <span class="op">=</span> post[<span class="st">"sigma"</span>].mean(dim <span class="op">=</span> [<span class="st">"chain"</span>, <span class="st">"draw"</span>]).sel(team <span class="op">=</span> away_team)</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>        away_points <span class="op">=</span> np.random.normal(away_mu, sigma)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>        home_points <span class="op">=</span> home_mu</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>        away_points <span class="op">=</span> away_mu</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (home_team, home_points, away_team, away_points)</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_winner(home_team, away_team, trace):</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>    home_team, home_points, away_team, away_points <span class="op">=</span> predict_game(home_team, away_team, trace, variance <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> home_team <span class="cf">if</span> home_points <span class="op">&gt;</span> away_points <span class="cf">else</span> away_team</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>predict_game(<span class="st">"Richmond"</span>, <span class="st">"Adelaide"</span>, trace, variance<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>('Richmond', array(82.89362002), 'Adelaide', array(92.0250401))</code></pre>
</div>
</div>
<p>Lets test the in sample accuracy for predicting the winner of games</p>
<div id="cell-30" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>trace <span class="op">=</span> az.from_netcdf(<span class="st">'trace.nc'</span>) <span class="co">#load model trace</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-31" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>games_2017 <span class="op">=</span> games.loc[games[<span class="st">"Year"</span>] <span class="op">==</span> <span class="dv">2017</span>].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>games_2017 <span class="op">=</span> games_2017[<span class="op">~</span>games_2017[<span class="st">"Round"</span>].<span class="bu">str</span>.contains(<span class="st">"F"</span>)] <span class="co">#remove finals</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>games_2017[<span class="st">'Winner'</span>] <span class="op">=</span> games_2017.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x[<span class="st">"HomeTeam"</span>] <span class="cf">if</span> x[<span class="st">"HomeTeamScore"</span>] <span class="op">&gt;</span> x[<span class="st">"AwayTeamScore"</span>] <span class="cf">else</span> x[<span class="st">"AwayTeam"</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>games_2017[<span class="st">'Predicted Winner'</span>] <span class="op">=</span> games_2017.<span class="bu">apply</span>(<span class="kw">lambda</span> x: predict_winner(x[<span class="st">"HomeTeam"</span>], x[<span class="st">"AwayTeam"</span>], trace), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>accuracy <span class="op">=</span> (games_2017[<span class="st">"Winner"</span>] <span class="op">==</span> games_2017[<span class="st">"Predicted Winner"</span>]).mean()</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(accuracy)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.702020202020202</code></pre>
</div>
</div>
<p>So we have a 70% in sample accuracy. Lets retrain a model on 2022 data to test the out of sample accuracy for the last 7 rounds of the season</p>
<p>We will have to reconstruct the team stats principal components as we can only take into account the first 17 rounds of the season, an assumption used here is that the team stats for the first 17 rounds can be scaled up by an appropriate factor to get the team stats for the whole 23 round season</p>
<div id="cell-33" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load player statistics</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>player_statistics <span class="op">=</span> pd.read_csv(<span class="st">'data/stats.csv'</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>player_statistics <span class="op">=</span> player_statistics.loc[player_statistics[<span class="st">'Year'</span>] <span class="op">&lt;=</span> <span class="dv">2022</span>].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Columns to keep</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>cols_to_keep <span class="op">=</span> [<span class="st">'Team'</span>, <span class="st">'Year'</span>, <span class="st">'Round'</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>       <span class="st">'Disposals'</span>, <span class="st">'Kicks'</span>, <span class="st">'Marks'</span>, <span class="st">'Handballs'</span>,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>       <span class="st">'HitOuts'</span>, <span class="st">'Tackles'</span>, <span class="st">'Rebounds'</span>, <span class="st">'Inside50s'</span>, <span class="st">'Clearances'</span>,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>       <span class="st">'Clangers'</span>, <span class="st">'Frees'</span>, <span class="st">'FreesAgainst'</span>, <span class="st">'ContestedPossessions'</span>, <span class="st">'UncontestedPossessions'</span>, <span class="st">'ContestedMarks'</span>,</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>       <span class="st">'MarksInside50'</span>, <span class="st">'OnePercenters'</span>, <span class="st">'Bounces'</span>]</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the DataFrame to keep only the necessary columns</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>team_stats_long <span class="op">=</span> player_statistics[cols_to_keep]</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Define rounds to keep (excluding finals for simplicity)</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>rounds_to_keep <span class="op">=</span> [<span class="st">'R'</span> <span class="op">+</span> <span class="bu">str</span>(i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">25</span>)]  <span class="co"># R1 to R24</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>first_17_rounds <span class="op">=</span> [<span class="st">'R'</span> <span class="op">+</span> <span class="bu">str</span>(i) <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">18</span>)]  <span class="co"># R1 to R17</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the DataFrame to include only the specified rounds</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>team_stats_long <span class="op">=</span> team_stats_long[team_stats_long[<span class="st">'Round'</span>].isin(rounds_to_keep)]</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop rows where Year is 2022 and Round is 17 or before</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>team_stats_long <span class="op">=</span> team_stats_long[<span class="op">~</span>((team_stats_long[<span class="st">'Year'</span>] <span class="op">==</span> <span class="dv">2022</span>) <span class="op">&amp;</span> <span class="op">~</span>team_stats_long[<span class="st">'Round'</span>].isin(first_17_rounds))]</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>team_stats_long.drop(<span class="st">'Round'</span>, axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>team_stats <span class="op">=</span> team_stats_long.groupby([<span class="st">'Team'</span>, <span class="st">'Year'</span>]).<span class="bu">sum</span>().sort_values([<span class="st">'Year'</span>, <span class="st">'Team'</span>]).reset_index()</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>stat_cols <span class="op">=</span> team_stats.select_dtypes(include<span class="op">=</span><span class="st">'number'</span>).columns.drop(<span class="st">'Year'</span>)</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>team_stats[stat_cols] <span class="op">=</span> team_stats[stat_cols].astype(<span class="bu">float</span>)</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>team_stats.loc[team_stats[<span class="st">'Year'</span>] <span class="op">==</span> <span class="dv">2022</span>, stat_cols] <span class="op">*=</span> (<span class="dv">23</span><span class="op">/</span><span class="dv">17</span>) <span class="co"># Scale the 2022 stats to 23 rounds</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>PCA_stats <span class="op">=</span> pca(team_stats)</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> Data(game_df, PCA_stats, <span class="dv">2022</span>, rounds<span class="op">=</span><span class="dv">17</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-34" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>trace <span class="op">=</span> create_model(data)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>az.to_netcdf(trace, <span class="st">'trace_2022.nc'</span>) <span class="co">#save trace for later use</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/jedtoner1/Desktop/Developer/AFLSeason/AFL/lib/python3.12/site-packages/pymc/data.py:274: FutureWarning: ConstantData is deprecated. All Data variables are now mutable. Use Data instead.
  warnings.warn(
/Users/jedtoner1/Desktop/Developer/AFLSeason/AFL/lib/python3.12/site-packages/pymc/data.py:274: FutureWarning: ConstantData is deprecated. All Data variables are now mutable. Use Data instead.
  warnings.warn(
Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [home_uncentered, scoring_intercept_uncentered, att_beta, offensive_intercept, def_beta, defensive_intercept, sigma_uncentered]</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">/Users/jedtoner1/Desktop/Developer/AFLSeason/AFL/lib/python3.12/site-packages/rich/live.py:231: UserWarning: 
install "ipywidgets" for Jupyter support
  warnings.warn('install "ipywidgets" for Jupyter support')
</pre>
</div>
<div class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Sampling 4 chains for 5_000 tune and 1_000 draw iterations (20_000 + 4_000 draws total) took 47 seconds.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>'trace_2022.nc'</code></pre>
</div>
</div>
<div id="cell-35" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>trace <span class="op">=</span> az.from_netcdf(<span class="st">'trace_2022.nc'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-36" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>games_2022 <span class="op">=</span> games.loc[games[<span class="st">"Year"</span>] <span class="op">==</span> <span class="dv">2022</span>].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>games_2022 <span class="op">=</span> games_2022[<span class="op">~</span>games_2022[<span class="st">"Round"</span>].<span class="bu">str</span>.contains(<span class="st">"F"</span>)] <span class="co">#remove finals</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>games_2022[<span class="st">'Winner'</span>] <span class="op">=</span> games_2022.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x[<span class="st">"HomeTeam"</span>] <span class="cf">if</span> x[<span class="st">"HomeTeamScore"</span>] <span class="op">&gt;</span> x[<span class="st">"AwayTeamScore"</span>] <span class="cf">else</span> x[<span class="st">"AwayTeam"</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>games_2022[<span class="st">'Predicted Winner'</span>] <span class="op">=</span> games_2022.<span class="bu">apply</span>(<span class="kw">lambda</span> x: predict_winner(x[<span class="st">"HomeTeam"</span>], x[<span class="st">"AwayTeam"</span>], trace), axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>test_rounds <span class="op">=</span> [<span class="ss">f'R</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">18</span>, <span class="dv">24</span>)]</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>test_games <span class="op">=</span> games_2022[games_2022[<span class="st">'Round'</span>].isin(test_rounds)]</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>accuracy <span class="op">=</span> (test_games[<span class="st">"Winner"</span>] <span class="op">==</span> test_games[<span class="st">"Predicted Winner"</span>]).mean()</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(accuracy)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.8148148148148148</code></pre>
</div>
</div>
<p>Surprisingly greater than the in sample accuracy for 2017, this could be due to 2022 being a more predictable season. Nonetheless a good result</p>
<p>Possible area for improvement:</p>
<ul>
<li>Implement form tracking - perhaps by time varying coefficients or a ‘form’ variable measuring effectiveness over past 5 games</li>
<li>Player level modelling - quantifying the contribution of each player to the team. This could form the basis of models spanning over multiple years and tracking player movement</li>
<li>Implementing variables such as weather, crowd impact and better handling of home advantage - perhaps specific to city or team</li>
<li>Tracking more advanced statistics that may have a higher impact on games, these might include meters gained, hard ball gets, broken tackles</li>
<li>Better handling/modelling of scoring sources - these include scoring from stoppage, kick ins and tunrover</li>
</ul>



</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/jedtoner\.github\.io");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© 2024 Jed Toner</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>Built with Quarto</p>
</div>
  </div>
</footer>




</body></html>